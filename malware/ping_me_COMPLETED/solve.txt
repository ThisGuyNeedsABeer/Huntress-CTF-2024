Name: Ping Me
Value: 441 points
Category: Malware
Solves: 110 Solves -
Author: @JohnHammond

Description:
We found this file in the autoruns of a host that seemed to have a lot of network activity... can you figure out what it was doing?

Download the file(s) below.

Attachments: ping_me.vbs

Solution:

1. Download the challenge file, and confirm that it is a VBS file.

┌──(kali㉿kali2024)-[~/CTF/huntress2024/malware/ping_me]
└─$ file ping_me.vbs  
ping_me.vbs: ASCII text, with very long lines (7064), with no line terminators

2. Upon inspection we see encoded VBS

3. To defang the VBS, we are going to remove the "Execute" directive with "Wscript.echo"

Wscript.echo chr(-8710+CLng(&H224A))&chr(CLng(&H1C3C)-7123)&chr(-1048+CLng(&H485))&chr(-431+CLng(&H1CF)) (...)

4. Now we can see what this does by firing it safely with Cscript and Wine

┌──(kali㉿kali2024)-[~/CTF/huntress2024/malware/ping_me]
└─$ wine cscript ping_me_defanged.vbs
Dim sh, ips, i:Set sh = CreateObject("WScript.Shell"):ips = Array("102.108.97.103", "123.54.100.49", "98.54.48.52", "98.98.49.98", "54.100.97.51", "50.98.56.98", "98.99.97.57", "101.50.54.100", "53.49.53.56", "57.125.35.35"):For i = 0 T
o UBound(ips):    sh.Run "cmd /Q /c ping " & ips(i), 0, False:Next

5. Cleaning the code up with ChatGPT, we can see the output as follows:

Dim sh, ips, i, pingResult, execObj
Set sh = CreateObject("WScript.Shell")  ' Creates a WScript.Shell object to run commands.
ips = Array("102.108.97.103", "123.54.100.49", "98.54.48.52", "98.98.49.98", "54.100.97.51", "50.98.56.98", "98.99.97.57", "101.50.54.100", "53.49.53.56", "57.125.35.35")
                                        ' Array of IP addresses to ping.

For i = 0 To UBound(ips)                ' Loop through each IP in the array.
    ' Execute the ping command and capture the output
    Set execObj = sh.Exec("cmd /c ping " & ips(i))
    
    ' Read all output from the ping command
    Do While Not execObj.StdOut.AtEndOfStream
        pingResult = execObj.StdOut.ReadAll()
    Loop
    
    ' Show the ping result in a message box
    MsgBox "Ping result for " & ips(i) & ":" & vbCrLf & pingResult
Next

6. Knowing that there is a flag here, and that we are just pinging let's examine the IP addresses.
   Breaking down the IP addresses to their decimal representation we get the following stirng:

102 108 97 103 123 54 100 49 98 54 48 52 98 98 49 98 54 100 97 51 50 98 56 98 98 99 97 57 101 50 54 100 53 49 53 56 57 125 35 35

7. Sending that string to Ciphey we can recover the flag

┌──(kali㉿kali2024)-[~/CTF/huntress2024/malware/ping_me]
└─$ ciphey -t "102 108 97 103 123 54 100 49 98 54 48 52 98 98 49 98 54 100 97 51 50 98 56 98 98 99 97 57 101 50 54 100 53 49 53 56 57 125 35 35"
Possible plaintext: 'flag{6d1b604bb1b6da32b8bbca9e26d51589}##' (y/N): y
╭─────────────────────────────────────────────────────────────────╮
│ The plaintext is a Capture The Flag (CTF) Flag                  │
│ Formats used:                                                   │
│    decimalPlaintext: "flag{6d1b604bb1b6da32b8bbca9e26d51589}##" │
╰─────────────────────────────────────────────────────────────────╯

8. Flag: flag{6d1b604bb1b6da32b8bbca9e26d51589}